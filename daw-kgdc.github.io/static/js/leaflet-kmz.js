!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self)["leaflet-kmz"]={})}(this,(function(e){"use strict";function t(e){return e["doc.kml"]?"doc.kml":function(e){return e.filter((e=>/.*\.kml/.test(e)))}(Object.keys(e))[0]}function i(e){return/\.(jpe?g|png|gif|bmp)$/i.test(e)}function o(e,t){return t instanceof Promise?t:Promise.all(e.map((e=>function(e){return new Promise(((t,i)=>{let o=document.createElement("script");o.addEventListener("load",t.bind(e),{once:!0}),o.src=e,document.head.appendChild(o)}))}(e))))}function n(e,t){let[i,o]=function(e){let t=L.latLngBounds([e.getElementsByTagName("south")[0].childNodes[0].nodeValue,e.getElementsByTagName("west")[0].childNodes[0].nodeValue],[e.getElementsByTagName("north")[0].childNodes[0].nodeValue,e.getElementsByTagName("east")[0].childNodes[0].nodeValue]),i=e.getElementsByTagName("rotation")[0];return void 0!==i&&(i=parseFloat(i.childNodes[0].nodeValue)),[t,i]}(e.getElementsByTagName("LatLonBox")[0]),n=e.getElementsByTagName("href")[0],r=e.getElementsByTagName("color")[0],a=e.getElementsByTagName("Icon")[0],s={};return!n&&a&&(n=a.getElementsByTagName("href")[0]),n=n.childNodes[0].nodeValue,n=t.icons[n]||n,r&&(r=r.childNodes[0].nodeValue,s.opacity=parseInt(r.substring(0,2),16)/255,s.color="#"+r.substring(6,8)+r.substring(4,6)+r.substring(2,4)),o&&(s.rotation=o),new L.KMZImageOverlay(n,i,{opacity:s.opacity,angle:s.rotation})}function r(e){var t=e instanceof ArrayBuffer?String.fromCharCode.apply(null,new Uint8Array(e)):e;return(new DOMParser).parseFromString(t,"text/xml")}const a=L.KMZLayer=L.FeatureGroup.extend({options:{interactive:!0,ballon:!0,bindPopup:!0,bindTooltip:!0,preferCanvas:!1},initialize:function(e,t){L.extend(this.options,t),L.Browser.mobile&&(this.options.bindTooltip=!1),this._layers={},e&&this.load(e)},add:function(e){this.load(e)},load:function(e){L.KMZLayer._jsPromise=o(this._requiredJSModules(),L.KMZLayer._jsPromise).then((()=>this._load(e)))},_load:function(e){let t=e[0],i=e[1];return this._parse(t,{name:i,icons:{}})},_parse:function(e,t){return i=e,"PK"===String.fromCharCode(new Uint8Array(i,0,1),new Uint8Array(i,1,1))?this._parseKMZ(e,t):this._parseKML(e,t);var i},_parseKMZ:function(e,o){var n;(n=e,new Promise(((e,t)=>{window.JSZip.loadAsync(n).then((t=>{var o=Object.keys(t.files).map((e=>{var o=t.files[e];if(i(e)){var n=e.split(".").pop().toLowerCase().replace("jpg","jpeg"),r=function(e,t){var i="text/plain";return/\.(jpe?g|png|gif|bmp)$/i.test(e)?i="image/"+t:/\.kml$/i.test(e)&&(i="text/plain"),i}(e,n);return o.async("base64").then((t=>[e,"data:"+r+";base64,"+t]))}return o.async("text").then((t=>[e,t]))}));Promise.all(o).then((t=>e(t.reduce(((e,t)=>(e[t[0]]=t[1],e)),{}))))}))}))).then((e=>{var n=t(e),r=Object.keys(e).filter((e=>i(e))),a=e[n];o.icons=r.reduce(((t,i)=>(t[i]=e[i],t)),{}),this._parseKML(a,o)}))},_parseKML:function(e,t){var i=r(e),o=function(e,t){var i=e instanceof XMLDocument?e:r(e),o=window.toGeoJSON.kml(i);return o.properties=L.extend({},o.properties,t||{}),o}(i,t),n=(this.options.geometryToLayer||this._geometryToLayer).call(this,o,i);this.addLayer(n),this.fire("load",{layer:n,name:o.properties.name})},_geometryToLayer:function(e,t){var i=this._map?this._map.options.preferCanvas:this.options.preferCanvas,o=L.geoJson(e,{pointToLayer:(t,o)=>i?L.kmzMarker(o,{iconUrl:e.properties.icons[t.properties.icon]||t.properties.icon,iconSize:[28,28],iconAnchor:[14,14],interactive:this.options.interactive}):L.marker(o,{icon:L.icon({iconUrl:e.properties.icons[t.properties.icon]||t.properties.icon,iconSize:[28,28],iconAnchor:[14,14]}),interactive:this.options.interactive}),style:e=>{var t={},i=e.properties;return i.stroke&&(t.stroke=!0,t.color=i.stroke),i.fill&&(t.fill=!0,t.fillColor=i.fill),i["stroke-opacity"]&&(t.opacity=i["stroke-opacity"]),i["fill-opacity"]&&(t.fillOpacity=i["fill-opacity"]),i["stroke-width"]&&(t.weight=1.05*i["stroke-width"]),t},onEachFeature:(e,t)=>{if(this.options.ballon){var i=e.properties,o=i.name||"",n=i.description||"";(o||n)&&(this.options.bindPopup&&t.bindPopup("<div><b>"+o+"</b><br>"+n+"</div>"),this.options.bindTooltip&&t.bindTooltip("<b>"+o+"</b>",{direction:"auto",sticky:!0}))}},interactive:this.options.interactive});let r=t.getElementsByTagName("GroundOverlay");for(let t,i=0;i<r.length;i++)t=n(r[i],e.properties),t&&o.addLayer(t);return o},_requiredJSModules:function(){var e=[],t="https://unpkg.com/";return"function"!=typeof window.JSZip&&e.push(t+"jszip@3.5.0/dist/jszip.min.js"),"object"!=typeof window.toGeoJSON&&e.push(t+"@tmcw/togeojson@4.1.0/dist/togeojson.umd.js"),e}});L.kmzLayer=function(e,t){return new L.KMZLayer(e,t)},L.KMZMarker=L.CircleMarker.extend({_updatePath:function(){var e=this._renderer,t=this._icon,i=this;e._drawing&&!i._empty()&&(t?t.drawImage():((t=this._icon=new Image(this.options.iconSize[0],this.options.iconSize[1])).anchor=[t.width/2,t.height/2],t.onload=t.drawImage=()=>{var o=i._point.subtract(t.anchor);e._ctx.drawImage(t,o.x,o.y,t.width,t.height)},t.src=this.options.iconUrl))}}),L.kmzMarker=function(e,t){return new L.KMZMarker(e,t)};var s=L.KMZMarker;L.KMZImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){if(L.DomUtil.TRANSFORM)this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var e=this.options.angle*(Math.PI/180),t=Math.cos(e),i=Math.sin(e);this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+t+", M12="+-i+", M21="+i+", M22="+t+")"}},getBounds:function(){return this._bounds}}),e.KMZLayer=a,e.KMZMarker=s,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=leaflet-kmz.js.map
